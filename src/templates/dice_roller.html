{% extends "layout.html.j2" %}

{% block title %}Dice Roller{% endblock %}

{% block content %}
<div class="dice-container">
    <!-- Guest Info Bar -->
    <div id="guest-info-bar" class="guest-info-bar" style="display: none;">
        <span id="guest-info-text">Du bist als Gast unterwegs. Noch <span id="rolls-left">10</span> kostenlose Würfe!</span>
        <a href="/auth/register" class="guest-register-btn">Kostenlos registrieren</a>
    </div>

    <div class="hero-content">
        <h1 class="hero-title">🎲 Würfel-Roller 🎲</h1>
        <p class="hero-description">
            Wähle deinen Würfel und lass das Glück entscheiden!
        </p>
        
        <div class="dice-grid">
            <button class="dice-button" onclick="rollDice(4)">
                <div class="dice-icon">🔹</div>
                <div>D4</div>
                <small>(1-4)</small>
            </button>
            <button class="dice-button" onclick="rollDice(6)">
                <div class="dice-icon">🎲</div>
                <div>D6</div>
                <small>(1-6)</small>
            </button>
            <button class="dice-button" onclick="rollDice(8)">
                <div class="dice-icon">🔸</div>
                <div>D8</div>
                <small>(1-8)</small>
            </button>
            <button class="dice-button" onclick="rollDice(10)">
                <div class="dice-icon">🔟</div>
                <div>D10</div>
                <small>(1-10)</small>
            </button>
            <button class="dice-button" onclick="rollDice(12)">
                <div class="dice-icon">🔷</div>
                <div>D12</div>
                <small>(1-12)</small>
            </button>
            <button class="dice-button" onclick="rollDice(20)">
                <div class="dice-icon">🎯</div>
                <div>D20</div>
                <small>(1-20)</small>
            </button>
        </div>

        <div id="dice-result" class="dice-result" style="display: none;">
            <div id="dice-animation" class="dice-animation">🎲</div>
            <div id="result-text"></div>
        </div>

        <div class="controls">
            <button class="btn btn-secondary" onclick="toggleMultiple()">🎲 Mehrere Würfel</button>
            <button class="btn btn-secondary" onclick="resetResults()">🔄 Zurücksetzen</button>
            <button class="btn btn-secondary" onclick="loadHistory()">📜 Historie laden</button>
            <button class="btn btn-secondary" onclick="shareLastRoll()" id="share-btn" style="display: none;">📤 Teilen</button>
        </div>

        <div id="multiple-dice" style="display: none; margin-top: 2rem;">
            <h3 style="color: white; margin-bottom: 1rem;">Mehrere Würfel würfeln</h3>
            <div class="multiple-dice-controls">
                <label style="color: white;">Anzahl: 
                    <input type="number" id="dice-count" value="2" min="1" max="10" 
                           style="width: 60px; padding: 0.5rem; border-radius: 5px; border: none; margin: 0 0.5rem;">
                </label>
                <label style="color: white;">Typ: 
                    <select id="dice-type" style="padding: 0.5rem; border-radius: 5px; border: none; margin: 0 0.5rem;">
                        <option value="4">D4</option>
                        <option value="6" selected>D6</option>
                        <option value="8">D8</option>
                        <option value="10">D10</option>
                        <option value="12">D12</option>
                        <option value="20">D20</option>
                    </select>
                </label>
                <button class="btn btn-primary" onclick="rollMultipleDice()">Würfeln!</button>
            </div>
        </div>

        <div id="history" class="history-section" style="margin-top: 2rem;">
            <h3 style="color: white; margin-bottom: 1rem;">📜 Würfel-Historie</h3>
            <div id="history-list" style="color: rgba(255, 255, 255, 0.8);">
                <p>Historie wird geladen...</p>
            </div>
        </div>
    </div>
</div>

<!-- Registration Overlay -->
<div id="registration-overlay" class="registration-overlay" style="display: none;">
    <div class="overlay-content">
        <div class="overlay-header">
            <h2>🎉 Du hast dein kostenloses Limit erreicht!</h2>
            <p>Du hast bereits 10 kostenlose Würfe gemacht. Registriere dich jetzt für unbegrenzte Würfe!</p>
        </div>
        
        <div class="overlay-benefits">
            <h3>✨ Was du erhältst:</h3>
            <ul>
                <li>🎲 Unbegrenzte Würfe</li>
                <li>📊 Erweiterte Statistiken</li>
                <li>📜 Vollständige Historie</li>
                <li>🎯 Benutzerdefinierte Würfel-Sets</li>
                <li>🏆 Achievements & Belohnungen</li>
            </ul>
        </div>
        
        <div class="overlay-actions">
            <a href="/auth/register" class="btn btn-primary btn-large">
                ✨ Jetzt kostenlos registrieren
            </a>
            <a href="/auth/login" class="btn btn-secondary">
                🔑 Bereits ein Konto? Anmelden
            </a>
            <button class="btn btn-ghost" onclick="closeOverlay()">
                ⏰ Später registrieren
            </button>
        </div>
    </div>
</div>

<script>
let isAuthenticated = {{ 'true' if current_user.is_authenticated else 'false' }};
let guestInfo = { is_guest: !isAuthenticated, rolls_left: 10, limit_reached: false };
let lastRollData = null;

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    checkGuestStatus();
    loadHistory();
});

async function checkGuestStatus() {
    if (isAuthenticated) {
        document.getElementById('guest-info-bar').style.display = 'none';
        return;
    }
    
    try {
        const response = await fetch('/auth/check-guest-limit');
        const data = await response.json();
        guestInfo = data;
        
        if (data.is_guest) {
            updateGuestInfoBar(data.rolls_left);
        }
    } catch (error) {
        console.error('Fehler beim Prüfen des Gast-Status:', error);
    }
}

function updateGuestInfoBar(rollsLeft) {
    const infoBar = document.getElementById('guest-info-bar');
    const rollsSpan = document.getElementById('rolls-left');
    
    if (rollsLeft <= 0) {
        infoBar.style.display = 'none';
        return;
    }
    
    rollsSpan.textContent = rollsLeft;
    infoBar.style.display = 'flex';
    
    // Warnung bei wenigen Würfen
    if (rollsLeft <= 3) {
        infoBar.classList.add('warning');
    }
}

async function rollDice(sides) {
    await performRoll(sides, 1);
}

async function rollMultipleDice() {
    const count = parseInt(document.getElementById('dice-count').value);
    const sides = parseInt(document.getElementById('dice-type').value);
    
    await performRoll(sides, count);
}

async function performRoll(sides, count) {
    // Animation starten
    showResult();
    animateDice();
    
    try {
        const response = await fetch('/api/roll', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                sides: sides,
                count: count
            })
        });
        
        const data = await response.json();
        
        if (!response.ok) {
            if (data.limit_reached) {
                showRegistrationOverlay();
                return;
            }
            throw new Error(data.error || 'Wurf fehlgeschlagen');
        }
        
        // Ergebnis anzeigen
        setTimeout(() => {
            displayResult(data);
            lastRollData = data; // Für Sharing speichern
            document.getElementById('share-btn').style.display = 'inline-block';
            
            // Gast-Info aktualisieren
            if (data.guest_info) {
                guestInfo = data.guest_info;
                updateGuestInfoBar(data.guest_info.rolls_left);
                
                if (data.guest_info.limit_reached) {
                    setTimeout(() => showRegistrationOverlay(), 2000);
                }
            }
            
            // Historie aktualisieren
            loadHistory();
        }, 1000);
        
    } catch (error) {
        console.error('Wurf-Fehler:', error);
        setTimeout(() => {
            displayError(error.message);
        }, 1000);
    }
}

function showResult() {
    document.getElementById('dice-result').style.display = 'block';
}

function animateDice() {
    const animation = document.getElementById('dice-animation');
    animation.style.animation = 'none';
    setTimeout(() => {
        animation.style.animation = 'spin 1s ease-in-out';
    }, 10);
}

function displayResult(data) {
    const resultText = data.dice_count === 1 
        ? `Du hast eine ${data.results[0]} gewürfelt!`
        : `${data.dice_count}x D${data.dice_sides}: [${data.results.join(', ')}] = ${data.total}`;
    
    document.getElementById('result-text').innerHTML = `
        <div style="font-size: 2rem; margin-bottom: 1rem;">${getResultEmoji(data.total)}</div>
        <div>${resultText}</div>
    `;
}

function displayError(message) {
    document.getElementById('result-text').innerHTML = `
        <div style="font-size: 2rem; margin-bottom: 1rem;">❌</div>
        <div style="color: #ff6b6b;">Fehler: ${message}</div>
    `;
}

function getResultEmoji(value) {
    if (value === 1) return '😅';
    if (value <= 3) return '😐';
    if (value <= 6) return '😊';
    if (value <= 10) return '🎉';
    if (value <= 15) return '🔥';
    return '⭐';
}

function toggleMultiple() {
    const multipleSection = document.getElementById('multiple-dice');
    multipleSection.style.display = multipleSection.style.display === 'none' ? 'block' : 'none';
}

async function loadHistory() {
    try {
        const response = await fetch('/api/history');
        const history = await response.json();
        updateHistoryDisplay(history);
    } catch (error) {
        console.error('Fehler beim Laden der Historie:', error);
        document.getElementById('history-list').innerHTML = '<p>Fehler beim Laden der Historie.</p>';
    }
}

function updateHistoryDisplay(history) {
    const historyList = document.getElementById('history-list');
    
    if (history.length === 0) {
        historyList.innerHTML = '<p>Noch keine Würfe vorhanden. Leg los!</p>';
        return;
    }
    
    historyList.innerHTML = history.map((roll, index) => {
        const resultText = roll.dice_count === 1 
            ? `D${roll.dice_sides}: ${roll.results[0]}`
            : `${roll.dice_count}x D${roll.dice_sides}: [${roll.results.join(', ')}] = ${roll.total}`;
        
        const date = new Date(roll.timestamp).toLocaleString('de-DE');
        
        return `
            <div style="padding: 0.8rem; background: rgba(255,255,255,0.1); margin: 0.3rem 0; border-radius: 8px; border-left: 3px solid #ff6b6b;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-weight: bold;">${resultText}</span>
                    <span style="font-size: 0.8rem; opacity: 0.7;">${date}</span>
                </div>
            </div>
        `;
    }).join('');
}

function resetResults() {
    document.getElementById('dice-result').style.display = 'none';
    loadHistory();
}

function showRegistrationOverlay() {
    document.getElementById('registration-overlay').style.display = 'flex';
}

function closeOverlay() {
    document.getElementById('registration-overlay').style.display = 'none';
}

async function shareLastRoll() {
    if (!lastRollData) {
        alert('Kein Würfelwurf zum Teilen verfügbar!');
        return;
    }
    
    try {
        const response = await fetch('/api/share-roll', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(lastRollData)
        });
        
        const shareData = await response.json();
        
        // Share-Dialog anzeigen
        showShareDialog(shareData);
        
    } catch (error) {
        console.error('Share-Fehler:', error);
        alert('Fehler beim Teilen des Würfelwurfs');
    }
}

function showShareDialog(shareData) {
    const shareUrl = window.location.origin + shareData.share_url;
    const text = lastRollData.dice_count === 1 
        ? `🎲 Ich habe eine ${lastRollData.results[0]} mit D${lastRollData.dice_sides} gewürfelt!`
        : `🎲 ${lastRollData.dice_count}x D${lastRollData.dice_sides} = ${lastRollData.total}! [${lastRollData.results.join(', ')}]`;
    
    const shareDialog = `
        <div id="share-dialog" class="share-dialog-overlay">
            <div class="share-dialog">
                <h3>📤 Würfelwurf teilen</h3>
                <p>${text}</p>
                <div class="share-options">
                    <button class="btn btn-primary" onclick="shareToSocial('twitter', '${shareUrl}', '${encodeURIComponent(text)}')">
                        🐦 Twitter
                    </button>
                    <button class="btn btn-primary" onclick="shareToSocial('facebook', '${shareUrl}', '${encodeURIComponent(text)}')">
                        📘 Facebook
                    </button>
                    <button class="btn btn-secondary" onclick="copyShareUrl('${shareUrl}')">
                        📋 Link kopieren
                    </button>
                </div>
                <button class="btn btn-ghost" onclick="closeShareDialog()">❌ Schließen</button>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', shareDialog);
}

function shareToSocial(platform, url, text) {
    let shareUrl = '';
    
    if (platform === 'twitter') {
        shareUrl = `https://twitter.com/intent/tweet?text=${text}&url=${encodeURIComponent(url)}`;
    } else if (platform === 'facebook') {
        shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`;
    }
    
    if (shareUrl) {
        window.open(shareUrl, '_blank', 'width=600,height=400');
    }
}

function copyShareUrl(url) {
    navigator.clipboard.writeText(url).then(() => {
        alert('🎉 Link wurde in die Zwischenablage kopiert!');
    }).catch(() => {
        // Fallback für ältere Browser
        const textArea = document.createElement('textarea');
        textArea.value = url;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        alert('🎉 Link wurde in die Zwischenablage kopiert!');
    });
}

function closeShareDialog() {
    const dialog = document.getElementById('share-dialog');
    if (dialog) {
        dialog.remove();
    }
}
</script>

<style>
.guest-info-bar {
    background: rgba(255, 107, 107, 0.2);
    color: white;
    padding: 1rem 2rem;
    margin-bottom: 1rem;
    border-radius: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border: 1px solid rgba(255, 107, 107, 0.3);
}

.guest-info-bar.warning {
    background: rgba(255, 165, 0, 0.3);
    border-color: rgba(255, 165, 0, 0.5);
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

.guest-register-btn {
    background: #ff6b6b;
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    text-decoration: none;
    font-weight: bold;
    transition: background 0.3s ease;
}

.guest-register-btn:hover {
    background: #ee5a52;
}

.registration-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(10px);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.overlay-content {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(20px);
    border-radius: 20px;
    padding: 3rem;
    max-width: 600px;
    width: 90%;
    text-align: center;
    border: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
}

.overlay-header h2 {
    color: white;
    font-size: 2.5rem;
    margin-bottom: 1rem;
}

.overlay-header p {
    color: rgba(255, 255, 255, 0.9);
    font-size: 1.2rem;
    margin-bottom: 2rem;
}

.overlay-benefits {
    text-align: left;
    margin: 2rem 0;
    background: rgba(255, 255, 255, 0.05);
    padding: 2rem;
    border-radius: 15px;
}

.overlay-benefits h3 {
    color: white;
    margin-bottom: 1rem;
    text-align: center;
}

.overlay-benefits ul {
    list-style: none;
    padding: 0;
}

.overlay-benefits li {
    color: rgba(255, 255, 255, 0.9);
    padding: 0.5rem 0;
    font-size: 1.1rem;
}

.overlay-actions {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.btn-large {
    padding: 1.2rem 2rem;
    font-size: 1.2rem;
}

.btn-ghost {
    background: transparent;
    color: rgba(255, 255, 255, 0.7);
    border: 1px solid rgba(255, 255, 255, 0.3);
}

.btn-ghost:hover {
    background: rgba(255, 255, 255, 0.1);
    color: white;
}

/* Share Dialog */
.share-dialog-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(10px);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1001;
}

.share-dialog {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(20px);
    border-radius: 20px;
    padding: 2rem;
    max-width: 500px;
    width: 90%;
    text-align: center;
    border: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
}

.share-dialog h3 {
    color: white;
    margin-bottom: 1rem;
    font-size: 1.5rem;
}

.share-dialog p {
    color: rgba(255, 255, 255, 0.9);
    margin-bottom: 2rem;
    font-size: 1.1rem;
}

.share-options {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
    justify-content: center;
}

.share-options .btn {
    flex: 1;
    min-width: 120px;
}

@media (max-width: 768px) {
    .overlay-content {
        padding: 2rem;
        margin: 1rem;
    }
    
    .overlay-header h2 {
        font-size: 2rem;
    }
    
    .guest-info-bar {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
    }
    
    .share-options {
        flex-direction: column;
    }
    
    .share-dialog {
        padding: 1.5rem;
    }
}
</style>
{% endblock %}